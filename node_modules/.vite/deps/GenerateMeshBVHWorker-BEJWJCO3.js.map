{
  "version": 3,
  "sources": ["../../@needle-tools/engine/src/engine/physics/workers/mesh-bvh/GenerateMeshBVHWorker.js"],
  "sourcesContent": ["import { Box3, BufferAttribute } from 'three';\r\nimport { MeshBVH } from 'three-mesh-bvh';\r\n\r\n// Modified according to https://github.com/gkjohnson/three-mesh-bvh/issues/636#issuecomment-2209571751\r\nimport { WorkerBase } from \"three-mesh-bvh/src/workers/utils/WorkerBase.js\";\r\nimport generateMeshBVHWorker from \"three-mesh-bvh/src/workers/generateMeshBVH.worker.js?worker&inline\";\r\n\r\nexport class GenerateMeshBVHWorker extends WorkerBase {\r\n\r\n\tconstructor() {\r\n\r\n\t\tsuper(new generateMeshBVHWorker());\r\n\t\tthis.name = 'GenerateMeshBVHWorker';\r\n\r\n\t}\r\n\r\n\trunTask( worker, geometry, options = {} ) {\r\n\r\n\t\treturn new Promise( ( resolve, reject ) => {\r\n\r\n\t\t\tif (\r\n\t\t\t\tgeometry.getAttribute( 'position' ).isInterleavedBufferAttribute ||\r\n\t\t\t\tgeometry.index && geometry.index.isInterleavedBufferAttribute\r\n\t\t\t) {\r\n\r\n\t\t\t\tthrow new Error( 'GenerateMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.' );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tworker.onerror = e => {\r\n\r\n\t\t\t\treject( new Error( `GenerateMeshBVHWorker: ${ e.message }` ) );\r\n\r\n\t\t\t};\r\n\r\n\t\t\tworker.onmessage = e => {\r\n\r\n\t\t\t\tconst { data } = e;\r\n\r\n\t\t\t\tif ( data.error ) {\r\n\r\n\t\t\t\t\treject( new Error( data.error ) );\r\n\t\t\t\t\tworker.onmessage = null;\r\n\r\n\t\t\t\t} else if ( data.serialized ) {\r\n\r\n\t\t\t\t\tconst { serialized, position } = data;\r\n\t\t\t\t\tconst bvh = MeshBVH.deserialize( serialized, geometry, { setIndex: false } );\r\n\t\t\t\t\tconst boundsOptions = Object.assign( {\r\n\r\n\t\t\t\t\t\tsetBoundingBox: true,\r\n\r\n\t\t\t\t\t}, options );\r\n\r\n\t\t\t\t\t// we need to replace the arrays because they're neutered entirely by the\r\n\t\t\t\t\t// webworker transfer.\r\n\t\t\t\t\tgeometry.attributes.position.array = position;\r\n\t\t\t\t\tif ( serialized.index ) {\r\n\r\n\t\t\t\t\t\tif ( geometry.index ) {\r\n\r\n\t\t\t\t\t\t\tgeometry.index.array = serialized.index;\r\n\r\n\t\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\t\tconst newIndex = new BufferAttribute( serialized.index, 1, false );\r\n\t\t\t\t\t\t\tgeometry.setIndex( newIndex );\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif ( boundsOptions.setBoundingBox ) {\r\n\r\n\t\t\t\t\t\tgeometry.boundingBox = bvh.getBoundingBox( new Box3() );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif ( options.onProgress ) {\r\n\r\n\t\t\t\t\t\toptions.onProgress( data.progress );\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tresolve( bvh );\r\n\t\t\t\t\tworker.onmessage = null;\r\n\r\n\t\t\t\t} else if ( options.onProgress ) {\r\n\r\n\t\t\t\t\toptions.onProgress( data.progress );\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t};\r\n\r\n\t\t\tconst index = geometry.index ? geometry.index.array : null;\r\n\t\t\tconst position = geometry.attributes.position.array;\r\n\t\t\tconst transferable = [ position ];\r\n\t\t\tif ( index ) {\r\n\r\n\t\t\t\ttransferable.push( index );\r\n\r\n\t\t\t}\r\n\r\n\t\t\tworker.postMessage( {\r\n\r\n\t\t\t\tindex,\r\n\t\t\t\tposition,\r\n\t\t\t\toptions: {\r\n\t\t\t\t\t...options,\r\n\t\t\t\t\tonProgress: null,\r\n\t\t\t\t\tincludedProgressCallback: Boolean( options.onProgress ),\r\n\t\t\t\t\tgroups: [ ... geometry.groups ],\r\n\t\t\t\t},\r\n\r\n\t\t\t}, transferable.map( arr => arr.buffer ).filter( v => ( typeof SharedArrayBuffer === 'undefined' ) || ! ( v instanceof SharedArrayBuffer ) ) );\r\n\r\n\t\t} );\r\n\r\n\t}\r\n\r\n}\r\n"],
  "mappings": ";;;;;;;AACA,SAAS,eAAe;AAGxB,SAAS,kBAAkB;AAC3B,OAAO,2BAA2B;AAE5B,IAAO,wBAAP,cAAqC,WAAU;EAEpD,cAAA;AAEC,UAAM,IAAI,sBAAqB,CAAE;AACjC,SAAK,OAAO;EAEb;EAEA,QAAS,QAAQ,UAAU,UAAU,CAAA,GAAE;AAEtC,WAAO,IAAI,QAAS,CAAE,SAAS,WAAW;AAEzC,UACC,SAAS,aAAc,UAAU,EAAG,gCACpC,SAAS,SAAS,SAAS,MAAM,8BAChC;AAED,cAAM,IAAI,MAAO,kGAAkG;;AAIpH,aAAO,UAAU,OAAI;AAEpB,eAAQ,IAAI,MAAO,0BAA2B,EAAE,SAAU,CAAE;MAE7D;AAEA,aAAO,YAAY,OAAI;AAEtB,cAAM,EAAE,KAAI,IAAK;AAEjB,YAAK,KAAK,OAAQ;AAEjB,iBAAQ,IAAI,MAAO,KAAK,KAAK,CAAE;AAC/B,iBAAO,YAAY;mBAER,KAAK,YAAa;AAE7B,gBAAM,EAAE,YAAY,UAAAA,UAAQ,IAAK;AACjC,gBAAM,MAAM,QAAQ,YAAa,YAAY,UAAU,EAAE,UAAU,MAAK,CAAE;AAC1E,gBAAM,gBAAgB,OAAO,OAAQ;YAEpC,gBAAgB;aAEd,OAAO;AAIV,mBAAS,WAAW,SAAS,QAAQA;AACrC,cAAK,WAAW,OAAQ;AAEvB,gBAAK,SAAS,OAAQ;AAErB,uBAAS,MAAM,QAAQ,WAAW;mBAE5B;AAEN,oBAAM,WAAW,IAAI,gBAAiB,WAAW,OAAO,GAAG,KAAK;AAChE,uBAAS,SAAU,QAAQ;;;AAM7B,cAAK,cAAc,gBAAiB;AAEnC,qBAAS,cAAc,IAAI,eAAgB,IAAI,KAAI,CAAE;;AAItD,cAAK,QAAQ,YAAa;AAEzB,oBAAQ,WAAY,KAAK,QAAQ;;AAIlC,kBAAS,GAAG;AACZ,iBAAO,YAAY;mBAER,QAAQ,YAAa;AAEhC,kBAAQ,WAAY,KAAK,QAAQ;;MAInC;AAEA,YAAM,QAAQ,SAAS,QAAQ,SAAS,MAAM,QAAQ;AACtD,YAAM,WAAW,SAAS,WAAW,SAAS;AAC9C,YAAM,eAAe,CAAE,QAAQ;AAC/B,UAAK,OAAQ;AAEZ,qBAAa,KAAM,KAAK;;AAIzB,aAAO,YAAa;QAEnB;QACA;QACA,SAAS;UACR,GAAG;UACH,YAAY;UACZ,0BAA0B,QAAS,QAAQ,UAAU;UACrD,QAAQ,CAAE,GAAI,SAAS,MAAM;;SAG5B,aAAa,IAAK,SAAO,IAAI,MAAM,EAAG,OAAQ,OAAO,OAAO,sBAAsB,eAAiB,EAAI,aAAa,kBAAmB,CAAE;IAE7I,CAAC;EAEF;;",
  "names": ["position"]
}
