import { existsSync, readFileSync } from "fs";
import { isAbsolute } from "path";
import path from "path";
import { warning } from "../utils/log.js";
import { savePackageJson } from "../utils/package-utils.js";
export function updateTypesRecursiveFromEngine(directory) {
    const enginePath = path.join(directory, 'node_modules/@needle-tools/engine/package.json');
    if (existsSync(enginePath) === false) {
        warning("Could not find @needle-tools/engine at " + enginePath + ". Skipping update of @types/three. Please update manually");
        return false;
    }
    const json = readFileSync(enginePath, 'utf8');
    const engineJson = JSON.parse(json);
    if (!engineJson.devDependencies) {
        return true;
    }
    const typesName = '@types/three';
    const typesVersion = engineJson.devDependencies[typesName];
    if (typesVersion === undefined) {
        return true;
    }
    updateTypes(directory, typesName, typesVersion);
    // update types for local dependencies
    const packageJsonPath = path.join(directory, 'package.json');
    if (existsSync(packageJsonPath) === false) {
        warning("Could not find package.json in " + directory + ". Skipping update of @types/three to " + typesVersion + ". Please update manually");
        return false;
    }
    const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf8'));
    if (packageJson.dependencies !== undefined) {
        for (const dependency in packageJson.dependencies) {
            let dependencyPath = packageJson.dependencies[dependency];
            if (dependencyPath.startsWith('file:')) {
                dependencyPath = dependencyPath.substring(5);
                if (isAbsolute(dependencyPath)) {
                    updateTypes(dependencyPath, typesName, typesVersion);
                }
                else {
                    updateTypes(path.join(directory, dependencyPath), typesName, typesVersion);
                }
            }
        }
    }
}
export function updateTypes(directory, typesName, typesVersion) {
    const packageJsonPath = path.join(directory, 'package.json');
    if (existsSync(packageJsonPath) === false) {
        warning("Could not find package.json in " + directory + ". Skipping update of @types/three to " + typesVersion + ". Please update manually");
        return false;
    }
    const json = readFileSync(packageJsonPath, 'utf8');
    const packageJson = JSON.parse(json);
    let updatedTypes = false;
    if (packageJson.devDependencies !== undefined) {
        if (packageJson.devDependencies[typesName] !== undefined && packageJson.devDependencies[typesName] !== typesVersion) {
            packageJson.devDependencies[typesName] = typesVersion;
            updatedTypes = true;
        }
    }
    if (updatedTypes) {
        console.log("Updating " + typesName + " in " + packageJson.name + " to " + typesVersion);
        savePackageJson(packageJsonPath, packageJson);
    }
    return true;
}
