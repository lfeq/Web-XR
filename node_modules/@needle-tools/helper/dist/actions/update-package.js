import { warning } from "../utils/log.js";
import { getPackageJson, savePackageJson } from "../utils/package-utils.js";
import { isVersion } from "../utils/version-utils.js";
import request from "request";
export async function updatePackages(packageJsonPath, packageNames) {
    const packageJson = getPackageJson(packageJsonPath);
    if (!packageJson) {
        console.error(`ERR: Could not find package.json at ${packageJsonPath}`);
        return;
    }
    const tasks = [];
    if (packageJson.dependencies) {
        for (const name of packageNames) {
            const task = updatePackageVersion(packageJson.dependencies, name);
            if (task)
                tasks.push(task);
        }
    }
    if (packageJson.devDependencies) {
        for (const name of packageNames) {
            const task = updatePackageVersion(packageJson.devDependencies, name);
            if (task)
                tasks.push(task);
        }
    }
    if (packageJson.peerDependencies) {
        for (const name of packageNames) {
            const task = updatePackageVersion(packageJson.peerDependencies, name);
            if (task)
                tasks.push(task);
        }
    }
    const results = await Promise.all(tasks);
    const changed = results.some(result => result);
    if (changed) {
        // write package json
        savePackageJson(packageJsonPath, packageJson);
    }
}
function updatePackageVersion(dict, packageName) {
    if (dict[packageName]) {
        console.log("Found package " + packageName);
        const version = dict[packageName];
        if (isVersion(version)) {
            return new Promise(async (res, _rej) => {
                let latestVersion = await getLatestNpmPackageVersion(packageName);
                console.log("Latest version: " + latestVersion);
                if (latestVersion === null) {
                    console.error(`ERR: Could not find package ${packageName} on npm`);
                    return false;
                }
                if (latestVersion !== version) {
                    if (version.startsWith("^")) {
                        latestVersion = "^" + latestVersion;
                    }
                    console.log(`Updating ${packageName} from ${version} to ${latestVersion}`);
                    dict[packageName] = latestVersion;
                    res(true);
                }
                res(false);
            });
        }
        else {
            warning(`Package "${packageName}" has a non-version value: "${version}" - will not update`);
        }
    }
    return null;
}
async function getLatestNpmPackageVersion(name) {
    const url = `https://registry.npmjs.org/${name}`;
    return new Promise((res, _rej) => {
        request(url, (error, response, body) => {
            if (error) {
                console.error(error);
                res(null);
            }
            else {
                const json = JSON.parse(body);
                const latestVersion = json["dist-tags"].latest;
                res(latestVersion);
            }
        });
    });
    return null;
}
