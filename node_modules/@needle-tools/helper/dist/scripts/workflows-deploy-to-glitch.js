import commandLineArgs from "command-line-args";
import { deploy_to_glitch } from "../workflows/deploy-to-glitch.js";
import { tryReadNeedleConfig } from "../utils/needle-config.js";
import { existsSync } from "fs";
import { tryReadFromEnv } from "../utils/env-utils.js";
import { getCurrentDirectory } from "../utils/path-utils.js";
const optionDefinitions = [
    { name: 'directory', type: String, multiple: false, defaultOption: true },
    { name: 'glitch', type: String, multiple: false },
    { name: 'key', type: String, multiple: false },
    { name: 'open', type: Boolean, multiple: false }
];
const options = commandLineArgs(optionDefinitions);
const currentDirectory = getCurrentDirectory();
if (!options.directory?.length) {
    // if no directory is specified, try to read it from needle.config
    const needleConfig = tryReadNeedleConfig({ directory: currentDirectory });
    if (needleConfig?.buildDirectory) {
        const directory = needleConfig.buildDirectory;
        if (existsSync(directory)) {
            console.log("[Deploy To Glitch]: Using build directory from needle.config: " + directory);
            options.directory = directory;
        }
    }
    if (!options.directory?.length) {
        console.error("No directory specified. Use --directory <directory>");
        process.exit(1);
    }
}
if (!options.glitch?.length) {
    const env = tryReadFromEnv("NEEDLE_GLITCH_URL");
    if (env) {
        console.log("[Deploy To Glitch]: Using Glitch URL from env: " + env);
        options.glitch = env;
    }
    if (!options.glitch?.length) {
        console.error("WARN: No Glitch endpoint specified. Use --glitch <url>, e.g. https://my-glitch-name.glitch.me or add it to your .env file as NEEDLE_GLITCH_URL=https://my-glitch-name.glitch.me");
        process.exit(1);
    }
}
if (!options.key?.length) {
    const env = tryReadFromEnv("NEEDLE_GLITCH_KEY");
    if (env) {
        console.log(`[Deploy To Glitch]: Using Glitch key from env: NEEDLE_GLITCH_KEY=${env.replace(/./g, "*")}`);
        options.key = env;
    }
    if (!options.key?.length) {
        console.error("WARN: No deployment key specified. Use --key <key> or add it to your .env file as NEEDLE_GLITCH_KEY=<key>");
        process.exit(1);
    }
}
deploy_to_glitch(options.directory, options.glitch, options.key, options.open);
